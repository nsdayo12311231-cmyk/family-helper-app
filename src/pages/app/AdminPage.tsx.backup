import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../../contexts/AuthContext';
import { useTaskManager } from '../../hooks/useTaskManager';
import { useTextDisplay } from '../../contexts/TextDisplayContext';
import { TEXT_MAPPINGS } from '../../utils/textMappings';
import { localStorageManager } from '../../utils/localStorage';
import type { Task } from '../../types';

const AdminPage = () => {
  const navigate = useNavigate();
  const { currentMember, family, members, addMember, deleteMember, clearTestData } = useAuth();
  const taskManager = currentMember && family ? useTaskManager(family.id, currentMember.id) : null;
  const [activeTab, setActiveTab] = useState<'tasks' | 'members' | 'settings'>('tasks');
  const [showAddTask, setShowAddTask] = useState(false);
  const [showAddMember, setShowAddMember] = useState(false);
  const [showChangePasscode, setShowChangePasscode] = useState(false);
  const [newPasscode, setNewPasscode] = useState('');
  const [confirmPasscode, setConfirmPasscode] = useState('');
  const [passcodeError, setPasscodeError] = useState('');
  const [selectedMemberFilter, setSelectedMemberFilter] = useState<string>('all');
  const [showEditRecord, setShowEditRecord] = useState<{type: 'pending' | 'goal' | 'investment', show: boolean}>({type: 'pending', show: false});
  const { textMode } = useTextDisplay();

  const handlePasscodeChange = () => {
    if (newPasscode.length !== 4) {
      setPasscodeError('ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯4æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    if (newPasscode !== confirmPasscode) {
      setPasscodeError('ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
      return;
    }

    localStorageManager.setAdminPasscode(newPasscode);
    setPasscodeError('');
    setNewPasscode('');
    setConfirmPasscode('');
    setShowChangePasscode(false);
    alert('ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
  };

  if (!currentMember || currentMember.role !== 'admin' || !taskManager) {
    return (
      <div className="p-4">
        <div className="card text-center py-12">
          <div className="text-6xl mb-4">ğŸ”’</div>
          <h2 className="text-2xl font-bold text-red-600 mb-4">
            {TEXT_MAPPINGS.accessRestricted[textMode]}
          </h2>
          <p className="text-lg text-gray-600">
            {TEXT_MAPPINGS.adminOnly[textMode]}
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="p-4 space-y-6">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="card hover-grow">
        <div className="flex items-center justify-between mb-4">
          <button
            onClick={() => navigate('/app')}
            className="bg-gradient-to-r from-blue-400 to-purple-500 hover:from-blue-500 hover:to-purple-600 text-white font-bold py-2 px-4 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg"
          >
            ğŸ  ãƒ›ãƒ¼ãƒ ã«ã‚‚ã©ã‚‹
          </button>
          <div className="flex-1"></div>
        </div>
        <h1 className="text-3xl font-bold text-center text-fun">
          ğŸ‘¨â€ğŸ’¼ {TEXT_MAPPINGS.adminScreen[textMode]} ğŸ‘¨â€ğŸ’¼
        </h1>
        <p className="text-center text-lg text-gray-600 mt-2">
          ã‹ããã® ã›ã£ã¦ã„ã‚’ ã‹ã‚“ã‚Šã—ã‚ˆã†
        </p>
      </div>

      {/* ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
      <div className="flex bg-gradient-to-r from-blue-100 to-purple-100 rounded-3xl p-2 border-4 border-blue-200 shadow-lg">
        <button
          onClick={() => setActiveTab('tasks')}
          className={`flex-1 py-3 px-4 rounded-2xl font-bold text-lg transition-all ${
            activeTab === 'tasks'
              ? 'bg-white text-blue-600 shadow-lg transform scale-105'
              : 'text-blue-500 hover:bg-white/50'
          }`}
        >
          ğŸ“ {TEXT_MAPPINGS.tasks[textMode]}
        </button>
        <button
          onClick={() => setActiveTab('members')}
          className={`flex-1 py-3 px-4 rounded-2xl font-bold text-lg transition-all ${
            activeTab === 'members'
              ? 'bg-white text-blue-600 shadow-lg transform scale-105'
              : 'text-blue-500 hover:bg-white/50'
          }`}
        >
          ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ {TEXT_MAPPINGS.members[textMode]}
        </button>
        <button
          onClick={() => setActiveTab('settings')}
          className={`flex-1 py-3 px-4 rounded-2xl font-bold text-lg transition-all ${
            activeTab === 'settings'
              ? 'bg-white text-blue-600 shadow-lg transform scale-105'
              : 'text-blue-500 hover:bg-white/50'
          }`}
        >
          âš™ï¸ {TEXT_MAPPINGS.settings[textMode]}
        </button>
      </div>

      {/* ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¿ãƒ– */}
      {activeTab === 'tasks' && (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold text-fun">ğŸ“ ã‚¿ã‚¹ã‚¯ ã‹ã‚“ã‚Š</h2>
            <button
              onClick={() => setShowAddTask(true)}
              className="btn-fun"
            >
              â• ã‚ãŸã‚‰ã—ã„ ã‚¿ã‚¹ã‚¯
            </button>
          </div>

          {/* ãƒ¡ãƒ³ãƒãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ */}
          <div className="card">
            <div className="flex items-center space-x-4">
              <label className="text-lg font-bold text-purple-600">ãƒ•ã‚£ãƒ«ã‚¿:</label>
              <select
                value={selectedMemberFilter}
                onChange={(e) => setSelectedMemberFilter(e.target.value)}
                className="flex-1 p-2 border-2 border-purple-200 rounded-xl text-lg"
              >
                <option value="all">ã™ã¹ã¦ã®ãƒ¡ãƒ³ãƒãƒ¼</option>
                {members.filter(member => member.role !== 'admin').map((member) => (
                  <option key={member.id} value={member.id}>
                    {member.avatar} {member.name}ã®ã‚¿ã‚¹ã‚¯
                  </option>
                ))}
              </select>
            </div>
          </div>

          <div className="space-y-4">
            {taskManager.tasks
              .filter((task) => selectedMemberFilter === 'all' || task.memberId === selectedMemberFilter)
              .map((task) => {
                const taskOwner = members.find(m => m.id === task.memberId);
                return (
              <div key={task.id} className="card hover-grow">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-4">
                    <div className="text-4xl">{task.icon}</div>
                    <div>
                      <div className="flex items-center space-x-2 mb-1">
                        <h3 className="text-xl font-bold text-purple-600">{task.name}</h3>
                        {taskOwner && (
                          <span className="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-sm font-bold">
                            {taskOwner.avatar} {taskOwner.name}
                          </span>
                        )}
                      </div>
                      <p className="text-gray-600">{task.description}</p>
                      <div className="flex space-x-4 text-sm text-gray-500 mt-1">
                        <span>ğŸ’° {task.reward}ãˆã‚“</span>
                        <span>ğŸ“… 1æ—¥{task.maxCompletionsPerDay}å›ã¾ã§</span>
                        <span className={task.isActive ? 'text-green-600' : 'text-red-600'}>
                          {task.isActive ? 'âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'âŒ ç„¡åŠ¹'}
                        </span>
                      </div>
                    </div>
                  </div>
                  <div className="flex space-x-2">
                    <button
                      onClick={() => taskManager.updateTask(task.id, { isActive: !task.isActive })}
                      className={`px-4 py-2 rounded-2xl font-bold transition-all ${
                        task.isActive
                          ? 'bg-red-400 hover:bg-red-500 text-white'
                          : 'bg-green-400 hover:bg-green-500 text-white'
                      }`}
                    >
                      {task.isActive ? 'ç„¡åŠ¹åŒ–' : 'æœ‰åŠ¹åŒ–'}
                    </button>
                    <button
                      onClick={() => taskManager.deleteTask(task.id)}
                      className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-2xl font-bold transition-all"
                    >
                      å‰Šé™¤
                    </button>
                  </div>
                </div>
              </div>
                );
              })}

            {taskManager.tasks.filter((task) => selectedMemberFilter === 'all' || task.memberId === selectedMemberFilter).length === 0 && (
              <div className="card text-center py-12">
                <div className="text-6xl mb-4">ğŸ“</div>
                <h3 className="text-2xl font-bold text-gray-600 mb-4">
                  {selectedMemberFilter === 'all' ? 'ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“' : 'é¸æŠã—ãŸãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“'}
                </h3>
                <p className="text-lg text-gray-500">
                  æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦å§‹ã‚ã¾ã—ã‚‡ã†
                </p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ã‚¿ãƒ– */}
      {activeTab === 'members' && (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold text-fun">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ãƒ¡ãƒ³ãƒãƒ¼ ã‹ã‚“ã‚Š</h2>
            <button
              onClick={() => setShowAddMember(true)}
              className="btn-fun"
            >
              â• ã‚ãŸã‚‰ã—ã„ ãƒ¡ãƒ³ãƒãƒ¼
            </button>
          </div>

          <div className="space-y-4">
            {members.map((member) => (
              <div key={member.id} className="card hover-grow">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-4">
                    <div className="text-4xl">{member.avatar}</div>
                    <div>
                      <h3 className="text-xl font-bold text-purple-600">{member.name}</h3>
                      <div className="flex space-x-4 text-sm text-gray-500">
                        <span>ğŸ‘¤ {member.role === 'admin' ? 'ç®¡ç†è€…' : 'å­ä¾›'}</span>
                        <span>ğŸ¨ {member.theme === 'boy' ? 'ç”·ã®å­' : 'å¥³ã®å­'}ãƒ†ãƒ¼ãƒ</span>
                      </div>
                    </div>
                  </div>
                  {member.role !== 'admin' && (
                    <button
                      onClick={() => {
                        if (confirm(`${member.name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                          deleteMember(member.id);
                        }
                      }}
                      className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-2xl font-bold transition-all"
                    >
                      å‰Šé™¤
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* è¨­å®šã‚¿ãƒ– */}
      {activeTab === 'settings' && (
        <div className="space-y-4">
          <h2 className="text-2xl font-bold text-fun">âš™ï¸ ãœã‚“ãŸã„ ã›ã£ã¦ã„</h2>

          <div className="card hover-grow">
            <h3 className="text-xl font-bold text-purple-600 mb-4">ğŸ  ã‹ãã ã˜ã‚‡ã†ã»ã†</h3>
            <div className="space-y-3">
              <div className="flex justify-between">
                <span className="text-gray-600">å®¶æ—å:</span>
                <span className="font-bold">{family?.name}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ãƒ¡ãƒ³ãƒãƒ¼æ•°:</span>
                <span className="font-bold">{members.length}äºº</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ä½œæˆæ—¥:</span>
                <span className="font-bold">
                  {family?.createdAt ? new Date(family.createdAt).toLocaleDateString('ja-JP') : '-'}
                </span>
              </div>
            </div>
          </div>

          <div className="card hover-grow">
            <h3 className="text-xl font-bold text-purple-600 mb-4">ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
            <div className="space-y-3">
              <div className="flex justify-between items-center">
                <span className="text-gray-600">ç¾åœ¨ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰:</span>
                <span className="font-bold text-lg">****</span>
              </div>
              <button
                onClick={() => setShowChangePasscode(true)}
                className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-2xl transition-all"
              >
                ğŸ”‘ ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´
              </button>
            </div>
          </div>

          <div className="card hover-grow">
            <h3 className="text-xl font-bold text-red-600 mb-4">ğŸ§ª ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½</h3>
            <div className="space-y-3">
              <p className="text-sm text-gray-600 mb-4">
                ãƒ†ã‚¹ãƒˆç”¨ã®æ©Ÿèƒ½ã§ã™ã€‚æœ¬ç•ªé‹ç”¨æ™‚ã¯å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
              </p>
              <button
                onClick={() => {
                  if (window.confirm('å…¨ã¦ã®ã‚¿ã‚¹ã‚¯å®Œäº†å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                    // ã‚¿ã‚¹ã‚¯å®Œäº†å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
                    localStorage.removeItem('taskCompletions');
                    alert('ã‚¿ã‚¹ã‚¯å®Œäº†å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    window.location.reload();
                  }
                }}
                className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-2xl transition-all"
              >
                ğŸ”„ ã‚¿ã‚¹ã‚¯å®Œäº†å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
              </button>
              <button
                onClick={() => {
                  if (window.confirm('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç²å¾—è¨˜éŒ²ã€æŒ¯ã‚Šåˆ†ã‘å¾…ã¡ã€ç›®æ¨™è²¯é‡‘ã€æŠ•è³‡ãªã©å…¨ã¦ã®ãŠé‡‘ãƒ‡ãƒ¼ã‚¿ï¼‰\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                    clearTestData();
                  }
                }}
                className="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-2xl transition-all"
              >
                ğŸ§¹ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã‚¯ãƒªã‚¢
              </button>
              <button
                onClick={() => {
                  if (window.confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                    // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                    const keysToKeep = ['theme', 'language']; // ä¿æŒã—ãŸã„ã‚­ãƒ¼
                    const allKeys = Object.keys(localStorage);
                    allKeys.forEach(key => {
                      if (!keysToKeep.includes(key)) {
                        localStorage.removeItem(key);
                      }
                    });
                    alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚');
                    window.location.reload();
                  }
                }}
                className="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-2xl transition-all"
              >
                ğŸ’¥ å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
              </button>
            </div>
          </div>

          <div className="card hover-grow">
            <h3 className="text-xl font-bold text-purple-600 mb-4">ğŸ”§ ãƒ‡ãƒ¼ã‚¿ä¿®å¾©</h3>
            <div className="space-y-3">
              <button
                onClick={() => {
                  if (confirm('memberIdãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã‚’ä¿®å¾©ã—ã¾ã™ã‹ï¼Ÿ')) {
                    // æ—¢å­˜ã‚¿ã‚¹ã‚¯ã®memberIdã‚’ä¿®å¾©
                    const tasks = taskManager?.tasks || [];
                    let fixedCount = 0;

                    tasks.forEach(task => {
                      if (!task.memberId) {
                        // memberIdãŒæœªè¨­å®šã®å ´åˆã€æœ€åˆã®å­ä¾›ãƒ¡ãƒ³ãƒãƒ¼ã«å‰²ã‚Šå½“ã¦
                        const firstChildMember = members.find(m => m.role !== 'admin');
                        if (firstChildMember) {
                          taskManager?.updateTask(task.id, {
                            memberId: firstChildMember.id
                          });
                          fixedCount++;
                        }
                      }
                    });

                    alert(`${fixedCount}å€‹ã®ã‚¿ã‚¹ã‚¯ã‚’ä¿®å¾©ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚`);
                  }
                }}
                className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-2xl transition-all"
              >
                ğŸ”§ å¤ã„ã‚¿ã‚¹ã‚¯ã®memberIdã‚’ä¿®å¾©
              </button>
            </div>
          </div>

          <div className="card hover-grow">
            <h3 className="text-xl font-bold text-purple-600 mb-4">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨˜éŒ²ç·¨é›†</h3>
            <div className="space-y-3">
              <button
                onClick={() => setShowEditRecord({type: 'pending', show: true})}
                className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-2xl transition-all"
              >
                ğŸ’° æŒ¯ã‚Šåˆ†ã‘å¾…ã¡é‡‘é¡ã‚’ç·¨é›†
              </button>

              <button
                onClick={() => setShowEditRecord({type: 'goal', show: true})}
                className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-2xl transition-all"
              >
                ğŸ¯ ç›®æ¨™è²¯é‡‘æ®‹é«˜ã‚’ç·¨é›†
              </button>

              <button
                onClick={() => setShowEditRecord({type: 'investment', show: true})}
                className="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-2xl transition-all"
              >
                ğŸ“ˆ æŠ•è³‡æ®‹é«˜ã‚’ç·¨é›†
              </button>

              <div className="mt-4 p-4 bg-gray-100 rounded-2xl">
                <h4 className="font-bold text-gray-700 mb-2">ğŸ’¡ ä½¿ã„æ–¹ã®ãƒ’ãƒ³ãƒˆ</h4>
                <div className="text-sm text-gray-600 space-y-1">
                  <p>â€¢ ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç•ªå·ã§é¸æŠã—ã¦ãã ã•ã„</p>
                  <p>â€¢ æœˆã®å½¢å¼: 2025-09 (å¹´-æœˆ)</p>
                  <p>â€¢ ç¾åœ¨ã®ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§:</p>
                  {members.map((member, index) => (
                    <p key={member.id} className="ml-4">
                      {index + 1}. {member.avatar} {member.name}
                    </p>
                  ))}
                </div>
              </div>
            </div>
          </div>

          <div className="card hover-grow">
            <h3 className="text-xl font-bold text-purple-600 mb-4">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ ãã†ã•</h3>
            <div className="space-y-3">
              <button
                onClick={() => {
                  if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                    localStorage.clear();
                    window.location.reload();
                  }
                }}
                className="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-2xl transition-all"
              >
                ğŸ—‘ï¸ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showAddTask && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-3xl p-6 max-w-md w-full border-4 border-blue-300 shadow-2xl">
            <h3 className="text-2xl font-bold text-center mb-6 text-fun">
              ğŸ“ ã‚ãŸã‚‰ã—ã„ ã‚¿ã‚¹ã‚¯
            </h3>
            <form onSubmit={(e) => {
              e.preventDefault();
              const formData = new FormData(e.target as HTMLFormElement);
              const selectedMemberId = formData.get('memberId') as string;

              taskManager.addTask({
                name: formData.get('name') as string,
                description: formData.get('name') as string, // èª¬æ˜ã¯åå‰ã¨åŒã˜ã«è¨­å®š
                icon: formData.get('icon') as string,
                reward: parseInt(formData.get('reward') as string),
                maxCompletionsPerDay: parseInt(formData.get('maxCompletions') as string),
                isActive: true,
                memberId: selectedMemberId,
                familyId: family!.id,
                updatedAt: new Date().toISOString(),
              });
              setShowAddTask(false);
            }}>
              <div className="space-y-4">
                <div>
                  <label className="block text-lg font-bold text-blue-600 mb-2">ã ã‚Œã® ã‚¿ã‚¹ã‚¯ï¼Ÿ</label>
                  <select
                    name="memberId"
                    required
                    className="w-full p-3 border-3 border-blue-200 rounded-2xl text-lg"
                  >
                    <option value="">ã ã‚Œã® ã‚¿ã‚¹ã‚¯ã‹ ãˆã‚‰ã‚“ã§ãã ã•ã„</option>
                    {members.filter(member => member.role !== 'admin').map((member) => (
                      <option key={member.id} value={member.id}>
                        {member.avatar} {member.name}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-lg font-bold text-blue-600 mb-2">ãªã¾ãˆ</label>
                  <input
                    name="name"
                    type="text"
                    required
                    className="w-full p-3 border-3 border-blue-200 rounded-2xl text-lg"
                    placeholder="ãŠã•ã‚‰ã‚ã‚‰ã„"
                  />
                </div>
                <div>
                  <label className="block text-lg font-bold text-blue-600 mb-2">ã‚¢ã‚¤ã‚³ãƒ³</label>
                  <select
                    name="icon"
                    required
                    defaultValue=""
                    className="w-full p-3 border-3 border-blue-200 rounded-2xl text-lg text-center text-3xl"
                    style={{ fontFamily: 'Apple Color Emoji, Segoe UI Emoji' }}
                  >
                    <option value="" disabled>ãˆã‚‰ã‚“ã§ãã ã•ã„</option>
                    <option value="ğŸ½ï¸">ğŸ½ï¸</option>
                    <option value="ğŸ§¹">ğŸ§¹</option>
                    <option value="ğŸ§º">ğŸ§º</option>
                    <option value="ğŸ“š">ğŸ“š</option>
                    <option value="ğŸ—‘ï¸">ğŸ—‘ï¸</option>
                    <option value="ğŸŒ¸">ğŸŒ¸</option>
                    <option value="ğŸ•">ğŸ•</option>
                    <option value="ğŸ›ï¸">ğŸ›ï¸</option>
                    <option value="ğŸ‘Ÿ">ğŸ‘Ÿ</option>
                    <option value="ğŸ“–">ğŸ“–</option>
                    <option value="ğŸ¯">ğŸ¯</option>
                    <option value="ğŸš¿">ğŸš¿</option>
                  </select>
                </div>
                <div>
                  <label className="block text-lg font-bold text-blue-600 mb-2">ã»ã†ã—ã‚…ã† (ãˆã‚“)</label>
                  <input
                    name="reward"
                    type="number"
                    required
                    min="1"
                    className="w-full p-3 border-3 border-blue-200 rounded-2xl text-lg"
                    placeholder="50"
                  />
                </div>
                <div>
                  <label className="block text-lg font-bold text-blue-600 mb-2">1ã«ã¡ã® ã‹ã„ã™ã†</label>
                  <input
                    name="maxCompletions"
                    type="number"
                    required
                    min="1"
                    max="10"
                    className="w-full p-3 border-3 border-blue-200 rounded-2xl text-lg"
                    placeholder="3"
                  />
                </div>
              </div>
              <div className="flex space-x-4 mt-6">
                <button
                  type="button"
                  onClick={() => setShowAddTask(false)}
                  className="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-2xl transition-all"
                >
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button
                  type="submit"
                  className="flex-1 btn-fun"
                >
                  ã¤ãã‚‹ï¼
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showAddMember && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-3xl p-6 max-w-md w-full border-4 border-purple-300 shadow-2xl">
            <h3 className="text-2xl font-bold text-center mb-6 text-fun">
              ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ã‚ãŸã‚‰ã—ã„ ãƒ¡ãƒ³ãƒãƒ¼
            </h3>
            <form onSubmit={(e) => {
              e.preventDefault();
              const formData = new FormData(e.target as HTMLFormElement);
              addMember({
                name: formData.get('name') as string,
                avatar: formData.get('avatar') as string,
                role: 'child',
                theme: formData.get('theme') as 'boy' | 'girl',
                textStyle: 'hiragana',
                displayOrder: members.length,
                isActive: true,
              });
              setShowAddMember(false);
            }}>
              <div className="space-y-4">
                <div>
                  <label className="block text-lg font-bold text-purple-600 mb-2">ãªã¾ãˆ</label>
                  <input
                    name="name"
                    type="text"
                    required
                    className="w-full p-3 border-3 border-purple-200 rounded-2xl text-lg"
                    placeholder="ãŸã‚ã†"
                  />
                </div>
                <div>
                  <label className="block text-lg font-bold text-purple-600 mb-2">ã‚¢ãƒã‚¿ãƒ¼</label>
                  <input
                    name="avatar"
                    type="text"
                    required
                    className="w-full p-3 border-3 border-purple-200 rounded-2xl text-lg"
                    placeholder="ğŸ‘¦"
                  />
                </div>
                <div>
                  <label className="block text-lg font-bold text-purple-600 mb-2">ãƒ†ãƒ¼ãƒ</label>
                  <select
                    name="theme"
                    required
                    className="w-full p-3 border-3 border-purple-200 rounded-2xl text-lg"
                  >
                    <option value="boy">ç”·ã®å­</option>
                    <option value="girl">å¥³ã®å­</option>
                  </select>
                </div>
              </div>
              <div className="flex space-x-4 mt-6">
                <button
                  type="button"
                  onClick={() => setShowAddMember(false)}
                  className="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-2xl transition-all"
                >
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button
                  type="submit"
                  className="flex-1 btn-fun"
                >
                  ã¤ã„ã‹ï¼
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showChangePasscode && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-3xl p-6 max-w-md w-full border-4 border-purple-300 shadow-2xl">
            <h3 className="text-2xl font-bold text-center mb-6 text-fun">
              ğŸ”‘ ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´
            </h3>

            {passcodeError && (
              <div className="bg-red-100 border-2 border-red-300 rounded-2xl p-3 mb-4">
                <p className="text-red-600 font-bold text-center text-sm">{passcodeError}</p>
              </div>
            )}

            <div className="space-y-4">
              <div>
                <label className="block text-lg font-bold text-purple-600 mb-2">æ–°ã—ã„ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆ4æ¡ï¼‰</label>
                <input
                  type="text"
                  maxLength={4}
                  value={newPasscode}
                  onChange={(e) => {
                    const value = e.target.value.replace(/[^0-9]/g, '');
                    setNewPasscode(value);
                    setPasscodeError('');
                  }}
                  className="w-full p-3 border-3 border-purple-200 rounded-2xl text-lg text-center font-bold"
                  placeholder="1234"
                />
              </div>
              <div>
                <label className="block text-lg font-bold text-purple-600 mb-2">ç¢ºèªç”¨ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</label>
                <input
                  type="text"
                  maxLength={4}
                  value={confirmPasscode}
                  onChange={(e) => {
                    const value = e.target.value.replace(/[^0-9]/g, '');
                    setConfirmPasscode(value);
                    setPasscodeError('');
                  }}
                  className="w-full p-3 border-3 border-purple-200 rounded-2xl text-lg text-center font-bold"
                  placeholder="1234"
                />
              </div>
            </div>

            <div className="flex space-x-4 mt-6">
              <button
                type="button"
                onClick={() => {
                  setShowChangePasscode(false);
                  setNewPasscode('');
                  setConfirmPasscode('');
                  setPasscodeError('');
                }}
                className="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-2xl transition-all"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button
                onClick={handlePasscodeChange}
                className="flex-1 btn-fun"
              >
                å¤‰æ›´ã™ã‚‹
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨˜éŒ²ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showEditRecord.show && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-3xl p-6 max-w-md w-full border-4 border-blue-300 shadow-2xl">
            <h3 className="text-2xl font-bold text-center mb-6 text-fun">
              {showEditRecord.type === 'pending' && 'ğŸ’° æŒ¯ã‚Šåˆ†ã‘å¾…ã¡é‡‘é¡ã‚’ç·¨é›†'}
              {showEditRecord.type === 'goal' && 'ğŸ¯ ç›®æ¨™è²¯é‡‘æ®‹é«˜ã‚’ç·¨é›†'}
              {showEditRecord.type === 'investment' && 'ğŸ“ˆ æŠ•è³‡æ®‹é«˜ã‚’ç·¨é›†'}
            </h3>
            <form onSubmit={(e) => {
              e.preventDefault();
              const formData = new FormData(e.target as HTMLFormElement);
              const memberId = formData.get('memberId') as string;
              const member = members.find(m => m.id === memberId);
              if (!member) {
                alert('ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
              }

              const amount = parseInt(formData.get('amount') as string);
              if (isNaN(amount) || amount < 0) {
                alert('æ­£ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
              }

              if (showEditRecord.type === 'pending') {
                const month = formData.get('month') as string;
                if (!month) {
                  alert('æœˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                  return;
                }
                localStorage.setItem(`pendingMoney-${family?.id}-${memberId}-${month}`, amount.toString());
                alert(`${member.name}ã®${month}ã®æŒ¯ã‚Šåˆ†ã‘å¾…ã¡é‡‘é¡ã‚’${amount}å††ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
              } else if (showEditRecord.type === 'goal') {
                localStorage.setItem(`goalSavings-${family?.id}-${memberId}`, amount.toString());
                alert(`${member.name}ã®ç›®æ¨™è²¯é‡‘æ®‹é«˜ã‚’${amount}å††ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
              } else if (showEditRecord.type === 'investment') {
                localStorage.setItem(`investment-${family?.id}-${memberId}`, amount.toString());
                alert(`${member.name}ã®æŠ•è³‡æ®‹é«˜ã‚’${amount}å††ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
              }

              setShowEditRecord({type: 'pending', show: false});
            }}>
              <div className="space-y-4">
                <div>
                  <label className="block text-lg font-bold text-purple-600 mb-2">
                    ãƒ¡ãƒ³ãƒãƒ¼
                  </label>
                  <select
                    name="memberId"
                    required
                    className="w-full p-3 border-3 border-purple-200 rounded-2xl text-lg"
                  >
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    {members.map(member => (
                      <option key={member.id} value={member.id}>
                        {member.avatar} {member.name}
                      </option>
                    ))}
                  </select>
                </div>

                {showEditRecord.type === 'pending' && (
                  <div>
                    <label className="block text-lg font-bold text-purple-600 mb-2">
                      æœˆ (å¹´-æœˆ)
                    </label>
                    <input
                      name="month"
                      type="text"
                      required
                      placeholder="2025-09"
                      className="w-full p-3 border-3 border-purple-200 rounded-2xl text-lg"
                    />
                  </div>
                )}

                <div>
                  <label className="block text-lg font-bold text-purple-600 mb-2">
                    é‡‘é¡ (å††)
                  </label>
                  <input
                    name="amount"
                    type="number"
                    required
                    min="0"
                    placeholder="1000"
                    className="w-full p-3 border-3 border-purple-200 rounded-2xl text-lg"
                  />
                </div>
              </div>

              <div className="flex space-x-4 mt-6">
                <button
                  type="button"
                  onClick={() => setShowEditRecord({type: 'pending', show: false})}
                  className="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-2xl transition-all"
                >
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button
                  type="submit"
                  className="flex-1 btn-fun"
                >
                  å¤‰æ›´ã™ã‚‹
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

export default AdminPage;